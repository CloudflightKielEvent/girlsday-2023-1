<!DOCTYPE html>
<html>
<head>
	<title>Cupcake Catcher</title>
</head>
<body>
	<canvas style="border:2px solid black" id="canvas"></canvas>
	<script>
		//Canvas
		var canvas = document.querySelector("#canvas");
		var ctx = canvas.getContext("2d");
		const WIDTH = 500;
		const HEIGHT = 500;
		canvas.width = WIDTH;
		canvas.height = HEIGHT;

		//Global Variables
		var score = 0;
		var level = 0;
		var lives = 0;
		var world = "Error";
		var animation = 0; // used for "flickering" of catchers eyes, can have values 0 and 1
		var foodTimer = 0;
		var gameOver = false;
		var paused;
		var levelTwo = false;
		var intervalVar;
		var foodList = [];
		var tileList = [];
		var foodDrop = [0,50,100,150,200,250,300,350,400,450]; //X Food Positions

		// Images
		var catcherOne = new Image();
		catcherOne.src = "images/catcher1.png";

		var catcherTwo = new Image();
		catcherTwo.src = "images/catcher2.png";

		var catcherThree = new Image();
		catcherThree.src = "images/catcher3.png";

		var catcherFour = new Image();
		catcherFour.src = "images/catcher4.png";

		var background = new Image();
		background.src = "images/background.jpg";

		var blood = new Image();
		blood.src = "images/blood.png";

		var tile = new Image();
		tile.src = "images/tile.png";

		var food = new Image();
		food.src = "images/food.png";

		//changes falling food to stars, when changing to space-world
		if (levelTwo) {
			food.src = "images/star.png";
		}

		// this is needed to load the images, so make sure you add any new images here, too!
		var allGameImages = [
			catcherOne,
			catcherTwo,
			catcherThree,
			catcherFour,
			background,
			blood,
			tile,
			food
		];

		//Objects
		var tileObject = {
			width: 50,
			height: 20
		}

		var foodObject = {
			width: 50,
			height: 50,
			speed: 3// try to set it speed to 1 (default: 3)
		}

		// player
		var catcher =  {
			x: 40,
			y: 350,
			width: 40, // try to set width to 70 (default: 40)
			height: 50,
			jump: 0, //Jump height, will be set to 100/-100 later (used to measure jumps)
			jumpUnit: 5, //Jump velocity
			onair: false, // if the player is currently jumping/inAir
			speed: 0, //Movement velocity
			leftPressed: false,
			rightPressed: false,
			gravity: 5, //try to set gravity to -10 (default: 5)
			safe: true,
		}

		// sounds
		sound = function(src){
			this.sound = document.createElement("audio");
			this.sound.src = src;
			this.sound.setAttribute("preload","auto");
			this.sound.setAttribute("controls","none");
			this.sound.style.display = "none";
			document.body.appendChild(this.sound);

			this.play = function(){
				this.sound.play();
			}

			this.pause = function(){
				this.sound.pause();
			}
		}

		var eatingSound = new sound("sound/eat.mp3");
		var droppingSound = new sound("sound/drop.mp3");


		// set the keys used in the game
		document.onkeydown = function(e){
			//LEFT "A"
			if(e.keyCode == 65 && catcher.x > 0){
				catcher.speed = -5;
				catcher.leftPressed = true;
			}

			//LEFT "CAPS LOCK" for super fast movement
			if(e.keyCode == 20 && catcher.x > 0){
				catcher.speed = -9;
				catcher.leftPressed = true;
			}

			//RIGHT "D"
			if(e.keyCode == 68 && catcher.x < WIDTH - catcher.width){
				catcher.speed = -5;
				catcher.rightPressed = true;
			}

			//RIGHT "F" for super fast movement
			if(e.keyCode == 70 && catcher.x < WIDTH - catcher.width){
				catcher.speed = -9;
				catcher.rightPressed = true;

			}

			//JUMP "W"
			if(e.keyCode == 87 && !catcher.onair){
				catcher.jump = 100;
				catcher.onair = true;
			}

			// PAUSE "space"
			if(e.keyCode == 32){
				if(paused){
					paused = false;
				} else {
					paused = true;
				}
			}

		}

		document.onkeyup = function(e){
			//LEFT A
			if(e.keyCode == 65){
				catcher.leftPressed = false;
			}
			//LEFT CAPS LOCK
			if(e.keyCode == 20){
				catcher.leftPressed = false;
			}
			//RIGHT D
			if(e.keyCode == 68){
				catcher.rightPressed = false;
			}
			//RIGHT F for fast movement
			if(e.keyCode == 70){
				catcher.rightPressed = false;
			}
		}

		//CHECK CONDITIONS checking of - catcher - food - tile - collision
		foodCatcherCondition = function(food){
			return ((food.x < catcher.x + catcher.width) && (catcher.x < food.x + foodObject.width)
					&& (food.y < catcher.y + catcher.height) && (catcher.y < food.y + foodObject.height));
		}

		foodTileCondition = function(food,tile){
			return ((food.x < tile.x + tileObject.width) && (tile.x < food.x + foodObject.width)
					&& (tile.y < tile.y + tileObject.height) && (tile.y < food.y + foodObject.height));
		}

		catcherTileCollision = function(tile){
			return((catcher.x < tile.x + tileObject.width)
					&&(tile.x <= catcher.x + catcher.width)
					&& (catcher.y + catcher.height <= tile.y));
		}

		// update player position while jumping
		jump = function(){
			//Moving Up
			if(catcher.jump > 0 && catcher.onair){ //CATCHER.JUMP CHANGED IN DOCUMENT.KEYDOWN CONDITION
				catcher.y -= catcher.jumpUnit; //Y position increase by jump unit
				catcher.jump -= catcher.jumpUnit; // Jump height decrease by jump unit, to reach maximum jump height (so the catcher doesn't keep lifting)
			}
			//Moving Down
			if(catcher.jump <= 0 && catcher.jump > -100 && catcher.onair){
				catcher.y += catcher.jumpUnit;
				catcher.jump -= catcher.jumpUnit;
			}
			if(catcher.jump <= -100 && catcher.onair){
				catcher.onair = false;
			}
		}

		// Update the food position and remove player-life if the food was not caught
		updateFoodPosition = function(){
			for(var i in foodList){
				//Delete food when out of canvas height
				if(foodList[i].y > HEIGHT){
					//Delete elements, start position i, delete 1 element
					foodList.splice(i, 1);
					lives--;

					if(lives == 0){
						gameEnd();
					}
				} else {
					foodList[i].y += foodObject.speed;
				}
			}
		}

		// update player position while moving sideways and falling
		updateCatcherPosition = function(){
			// update position to the left
			if(catcher.leftPressed && catcher.x > 0){
				catcher.x += catcher.speed;
			}
			// update position to the right
			if(catcher.rightPressed && catcher.x < WIDTH - catcher.width){
				catcher.x -= catcher.speed;
			}

			// if the player leaves the canvas, we know it's game over
			if(catcher.y > HEIGHT - catcher.height) {
				//droppingSound.play();
				catcher.y = HEIGHT - catcher.height;
				gameOver = true;
			}

		}

		// adding level two
		nextLevel = function (){
			levelTwo = true;
			foodObject.speed = 5;  // stars move faster, making space-world more difficult
			foodObject.width = 40; // size of stars
			foodObject.height = 40;
			background.src = "images/background_purple.jpg";  // background for space-world
			world = "space-world"; // changes world name
			catcher.x = 100;
			catcher.y = 350;
			catcher.onair = false;
			catcher.leftPressed = false;
			catcher.rightPressed = false;
			catcher.safe = true;
			animation = 0;
			foodTimer = 0;
			gameOver = false;
			tileList = [];
			foodList = [];

			for(var i=0; i<=9; i++){
				tileList.push({x: i * 50, y:400});
			}
		}

		// handle game end
		gameEnd = function(){
			ctx.globalAlpha = 0.55;
			drawObject(blood, 100,100,300,300);
			ctx.globalAlpha = 1.0;
			ctx.strokeStyle = "white";
			ctx.font = "30px Calibri";
			ctx.strokeText("Game Over", 180,200);
			ctx.strokeText("Click to Restart",160,HEIGHT/2);
			clearInterval(intervalVar);
		}

		// update positions of moving elements
		updatePosition = function(){
			ctx.clearRect(0,0,WIDTH,HEIGHT);
			drawObject(background,0,0,WIDTH,HEIGHT);
			foodTimer++;
			if(foodTimer > level){
				foodList.push({x:foodDrop[Math.round(Math.random() * 9)],y:0});
				foodTimer = 0;
			}

			// if it is gameover, show correct catcher image and end the game
			if(gameOver == true){
				drawObject(catcherThree,catcher.x,470,50,30);
				gameEnd();
			}
			// if the catcher is onair, show correct catcher image
			else if(catcher.onair){
				drawObject(catcherFour,catcher.x,catcher.y,catcher.width,catcher.height);
			}
			// if the catcher is not in the air, toggle animation of eyes (by changing between images 1+2 of the catcher)
			else if(animation == 0){
				drawObject(catcherTwo,catcher.x,catcher.y,catcher.width,catcher.height);
				animation = 1;
			} else {
				drawObject(catcherOne,catcher.x,catcher.y,catcher.width,catcher.height);
				animation = 0;
			}

			// draw the food items
			for(var i in foodList){
				drawObject(food,foodList[i].x,foodList[i].y,foodObject.width,foodObject.height);
			}

			// draw the tile items
			for(var i=0;i<tileList.length;i++){ // try to comment out the for loop
				drawObject(tile,tileList[i].x,tileList[i].y,tileObject.width,tileObject.height);
			};

			// count score when catching food
			for(var i in foodList){
				if(foodCatcherCondition(foodList[i])){
					score++;
					//eatingSound.play();
					if(score % 2 == 0){
						level--;
					}
					if(score == 10) {
						nextLevel();
					}
					foodList.splice(i, 1);
				}
			}

			// remove tile when food collides with it
			for(var i in foodList){
				for(var j in tileList){
					if(foodTileCondition(foodList[i],tileList[j])){
						tileList.splice(j,1);
					}
				}
			}

			// handle catcher gravity (while falling through missing tiles)
			if(!catcher.onair){
				for(var i in tileList){
					if(catcherTileCollision(tileList[i])){
						catcher.safe = true;
						break;
					}
					catcher.safe = false;
				}
				if(!catcher.safe){
					catcher.y += catcher.gravity;
				}
			}

			// draw updates on game canvas
			drawObject(food,440,10,20,20);
			ctx.fillStyle = "white";
			ctx.font = "20px Calibri";
			ctx.fillText(score,465,27);
			ctx.fillText("Level: " + (100 - level + 1),10,27);
			ctx.fillText("Lives: " + lives,350,27);
			ctx.fillText("World: " + world, 110, 27);

			updateFoodPosition();
			updateCatcherPosition();
			jump();

		}

		// either update position or show pause screen
		updateGame = function() {
			if (!paused) {
				updatePosition();
			}
			else {
				ctx.strokeStyle = "white";
				ctx.font = "30px Calibri";
				ctx.strokeText("Game Paused",160,HEIGHT/2);
			}
		}

		// start the game by defining initial values
		startGame = function(){
			levelTwo = false;
			world = "Cupcake-World"
			score = 0;
			lives = 5; // try to set it to 10
			level = 100;
			catcher.x = 100;
			catcher.y = 350;
			catcher.onair = false;
			catcher.leftPressed = false;
			catcher.rightPressed = false;
			catcher.safe = true;
			animation = 0;
			foodTimer = 0;
			gameOver = false;
			tileList = [];
			foodList = [];


			for(var i=0; i<=9; i++){
				tileList.push({x: i * 50, y:400});
			}

			// enable actual gameplay by regularly updating the game interface
			intervalVar = setInterval(updateGame, 10);
		}

		// start game
		generalGameStart = function() {
			ctx.drawImage(background,0,0,WIDTH,HEIGHT);
			ctx.strokeStyle = "white";
			ctx.font = "30px Calibri";
			ctx.strokeText("Click Here to Start",WIDTH/4,HEIGHT/2);

			// Game Area
			drawObject = function(object,x,y,width,height){
				ctx.drawImage(object,x,y,width,height);
			}

			document.getElementById("canvas").onmousedown = function(){
				if(!gameOver){
					clearInterval(intervalVar);
				}
				startGame();
			}
		}

		// finally, load all images and start the game!
		window.onload = function() {
			Promise.all(allGameImages.map((aImage) => {
				new Promise((resolve) => {
					aImage.addEventListener('load', () => resolve);
				})
			})).then(() => {
				// start game here
				generalGameStart();
			})
		}
	</script>
</body>
</html>
